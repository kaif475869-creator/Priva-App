<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Pwice - Global Private Connect</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
 --pw-blue:#0095f6;
 --pw-dark:#000;
 --pw-card:#1c1c1e;
 --pw-text:#fff;
 --pw-grad:linear-gradient(to right,#80d0ff,#b399ff,#d9b3ff);
}

/* üîí PURE APP BEHAVIOR */
html, body{
 margin:0;
 height:100%;
 overscroll-behavior:none;
 touch-action:manipulation;
}

*{box-sizing:border-box}

body{
 font-family:-apple-system, sans-serif;
 background:var(--pw-dark);
 color:var(--pw-text);
 overflow:hidden;
}

.hidden{display:none!important}

.logo-text{
 font-size:3rem;
 font-weight:900;
 font-style:italic;
 background:var(--pw-grad);
 -webkit-background-clip:text;
 -webkit-text-fill-color:transparent;
 letter-spacing:-2px;
}

/* Loader */
#loader{
 position:fixed;
 inset:0;
 display:flex;
 justify-content:center;
 align-items:center;
 background:#000;
 z-index:9999;
}

/* Navbar Fix for Better Click */
nav{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:10px 20px;
 border-bottom:1px solid #262626;
 position: relative;
 z-index: 10;
}

/* üî• BIG CLICK TARGET FOR MOBILE */
.chat-icon-btn{
 font-size:1.8rem;
 background:none;
 border:none;
 color:white;
 cursor:pointer;
 padding: 10px 15px; /* Larger area */
 -webkit-tap-highlight-color: transparent;
}

/* Views */
.view-container{
 height:calc(100vh - 120px);
 overflow-y:auto;
 -webkit-overflow-scrolling: touch;
}

/* Bottom Nav */
.bottom-bar{
 position:fixed;
 bottom:0;
 width:100%;
 display:flex;
 justify-content:space-around;
 padding:15px 0;
 border-top:1px solid #262626;
 background:#000;
 font-size:1.8rem;
 z-index: 10;
}

/* Chat Full Screen (Instagram Style) */
#chat-view{
 position:fixed;
 inset:0;
 background:#000;
 z-index:1000;
 display:flex;
 flex-direction:column;
}

.chat-header{
 display:flex;
 align-items:center;
 gap:10px;
 padding:15px;
 border-bottom:1px solid #262626;
}

.message-box{
 flex:1;
 padding:15px;
 overflow-y:auto;
 display:flex;
 flex-direction:column;
 gap:8px;
}

.msg{
 max-width:75%;
 padding:10px 14px;
 border-radius:18px;
 font-size:1rem;
}

.sent{
 align-self:flex-end;
 background:var(--pw-blue);
 border-bottom-right-radius:4px;
}

.received{
 align-self:flex-start;
 background:#262626;
 border-bottom-left-radius:4px;
}

/* üåü Seen & Typing Styling */
.status-text{
 font-size: 0.75rem;
 color: #8e8e8e;
 padding: 0 15px 5px;
 font-style: italic;
}

.chat-input-area{
 display:flex;
 gap:10px;
 padding:10px;
 border-top:1px solid #262626;
 background: #000;
}

.chat-input{
 flex:1;
 padding:12px 18px;
 border-radius:25px;
 border:1px solid #333;
 background:#1a1a1a;
 color:white;
 outline:none;
}
</style>
</head>

<body>

<div id="loader"><div class="logo-text">Pwice</div></div>

<div id="main-app" class="hidden">

<nav id="top-nav">
 <div class="logo-text" style="font-size:1.8rem">Pwice</div>
 <button class="chat-icon-btn" onclick="switchTab('chat')">‚úâÔ∏è</button>
</nav>

<div id="feed-view" class="view-container"></div>

<div id="chat-view" class="hidden">
 <div class="chat-header">
  <span style="cursor:pointer;font-size:1.8rem;padding:5px" onclick="switchTab('feed')">‚¨ÖÔ∏è</span>
  <b>Direct</b>
  <span id="seen-status" style="margin-left:auto; font-size:0.7rem; color:#8e8e8e;"></span>
 </div>

 <div id="msg-list" class="message-box"></div>
 
 <div id="typing-indicator" class="status-text hidden">typing...</div>

 <div class="chat-input-area">
  <input id="chat-input" class="chat-input" placeholder="Message..." oninput="handleTyping()">
  <button onclick="sendMsg()" style="color:var(--pw-blue);background:none;border:none;font-weight:bold;font-size:1rem;padding:0 10px;">Send</button>
 </div>
</div>

<div id="profile-view" class="view-container hidden" style="text-align:center;padding-top:50px">
 <h3 id="p-name"></h3>
 <button onclick="logout()" style="background:#e74c3c;color:white;border:none;padding:12px 24px;border-radius:10px;font-weight:bold">Logout</button>
</div>

<div id="bottom-nav" class="bottom-bar">
 <div onclick="switchTab('feed')">üè†</div>
 <div onclick="switchTab('profile')">üë§</div>
</div>

</div>

<script>
const supabaseUrl='https://xgxmbfbuplkzwnrueusy.supabase.co';
const supabaseKey='sb_publishable_W-5nmUs4gRcD0BDsv7BM9w_R6rpx87j';
const _supabase=supabase.createClient(supabaseUrl,supabaseKey);

let currentUserId = null;
let typingTimeout;

async function init(){
 const {data:{session}}=await _supabase.auth.getSession();
 if(session) {
    updateUI(session);
 } else {
    // Agar session na ho toh refresh fix ke liye
    _supabase.auth.onAuthStateChange((_e,s) => updateUI(s));
 }
 document.getElementById('loader').classList.add('hidden');
}

function updateUI(session){
 if(session){
  currentUserId = session.user.id;
  document.getElementById('main-app').classList.remove('hidden');
  document.getElementById('p-name').innerText=session.user.email;
  fetchFeed();
  listenMessages(session.user.id);
 }
}

function switchTab(tab){
 ['feed-view','profile-view','chat-view'].forEach(v=>document.getElementById(v).classList.add('hidden'));
 document.getElementById('top-nav').classList.remove('hidden');
 document.getElementById('bottom-nav').classList.remove('hidden');

 if(tab==='feed')document.getElementById('feed-view').classList.remove('hidden');
 if(tab==='profile')document.getElementById('profile-view').classList.remove('hidden');
 if(tab==='chat'){
  document.getElementById('chat-view').classList.remove('hidden');
  document.getElementById('top-nav').classList.add('hidden');
  document.getElementById('bottom-nav').classList.add('hidden');
  // üåü Mark as Seen logic
  document.getElementById('seen-status').innerText = "Seen just now";
 }
}

function listenMessages(uid){
 _supabase.channel('messages')
 .on('postgres_changes',{event:'INSERT',table:'messages'},payload=>{
  const isMe=payload.new.sender_id===uid;
  const list = document.getElementById('msg-list');
  list.innerHTML+= `<div class="msg ${isMe?'sent':'received'}">${payload.new.text}</div>`;
  list.scrollTop = list.scrollHeight;
 }).subscribe();
}

// üåü Typing Logic
function handleTyping() {
    document.getElementById('typing-indicator').classList.remove('hidden');
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        document.getElementById('typing-indicator').classList.add('hidden');
    }, 1500);
}

async function sendMsg(){
 const input=document.getElementById('chat-input');
 if(!input.value.trim() || !currentUserId) return;
 
 await _supabase.from('messages').insert([{
    sender_id: currentUserId,
    receiver_id: currentUserId, // testing self-chat
    text: input.value
 }]);
 input.value='';
}

async function fetchFeed(){
 const {data}=await _supabase.from('posts').select('*').order('created_at',{ascending:false});
 const feed=document.getElementById('feed-view');
 feed.innerHTML='';
 data?.forEach(p=>{
  feed.innerHTML+=`<div style="padding:15px"><img src="${p.image_url}" style="width:100%;border-radius:15px;border:1px solid #1a1a1a"></div>`;
 });
}

async function logout(){await _supabase.auth.signOut(); window.location.reload();}

window.onload=init;
</script>

</body>
</html>
