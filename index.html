<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pwice - Global Private Connect</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
 --pw-blue:#0095f6;
 --pw-dark:#000;
 --pw-card:#1c1c1e;
 --pw-text:#fff;
 --pw-grad:linear-gradient(to right,#80d0ff,#b399ff,#d9b3ff);
}

*{box-sizing:border-box}
body{
 margin:0;
 font-family:-apple-system, sans-serif;
 background:var(--pw-dark);
 color:var(--pw-text);
 height:100vh;
 overflow:hidden;
}

.hidden{display:none!important}

.logo-text{
 font-size:3rem;
 font-weight:900;
 font-style:italic;
 background:var(--pw-grad);
 -webkit-background-clip:text;
 -webkit-text-fill-color:transparent;
 letter-spacing:-2px;
}

/* Loader */
#loader{
 position:fixed;
 inset:0;
 display:flex;
 justify-content:center;
 align-items:center;
 background:#000;
 z-index:9999;
}

/* Auth */
#auth-page{
 height:100vh;
 display:flex;
 flex-direction:column;
 justify-content:center;
 align-items:center;
 padding:20px;
}

input{
 width:100%;
 padding:14px;
 margin:10px 0;
 background:#1a1a1a;
 border:1px solid #333;
 color:white;
 border-radius:10px;
 outline:none;
}

/* Navbar */
nav{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:10px 20px;
 border-bottom:1px solid #262626;
}

.chat-icon-btn{
 font-size:1.7rem;
 background:none;
 border:none;
 color:white;
 cursor:pointer;
}

/* Views */
.view-container{
 height:calc(100vh - 120px);
 overflow-y:auto;
}

/* Bottom Nav */
.bottom-bar{
 position:fixed;
 bottom:0;
 width:100%;
 display:flex;
 justify-content:space-around;
 padding:15px 0;
 border-top:1px solid #262626;
 background:#000;
 font-size:1.8rem;
}

/* Chat Full Screen */
#chat-view{
 position:fixed;
 inset:0;
 background:#000;
 z-index:999;
 display:flex;
 flex-direction:column;
}

.chat-header{
 display:flex;
 align-items:center;
 gap:10px;
 padding:15px;
 border-bottom:1px solid #262626;
}

.message-box{
 flex:1;
 padding:15px;
 overflow-y:auto;
 display:flex;
 flex-direction:column;
 gap:8px;
}

.msg{
 max-width:75%;
 padding:10px 14px;
 border-radius:18px;
 font-size:1rem;
}

.sent{
 align-self:flex-end;
 background:var(--pw-blue);
 border-bottom-right-radius:4px;
}

.received{
 align-self:flex-start;
 background:#262626;
 border-bottom-left-radius:4px;
}

.chat-input-area{
 display:flex;
 gap:10px;
 padding:10px;
 border-top:1px solid #262626;
}

.chat-input{
 flex:1;
 padding:12px;
 border-radius:25px;
 border:1px solid #333;
 background:#1a1a1a;
 color:white;
 outline:none;
}
</style>
</head>

<body>

<div id="loader"><div class="logo-text">Pwice</div></div>

<!-- AUTH -->
<div id="auth-page" class="hidden">
 <div class="logo-text">Pwice</div>
 <div style="background:var(--pw-card);padding:30px;border-radius:20px;width:100%;max-width:350px;">
  <input id="u-email" placeholder="Email">
  <input id="u-pass" type="password" placeholder="Password">
  <button onclick="handleAuth()" style="width:100%;padding:14px;background:var(--pw-blue);border:none;border-radius:10px;color:white;font-weight:bold">Login</button>
 </div>
</div>

<!-- MAIN -->
<div id="main-app" class="hidden">

<nav id="top-nav">
 <div class="logo-text" style="font-size:1.6rem">Pwice</div>
 <button class="chat-icon-btn" onclick="switchTab('chat')">‚úâÔ∏è</button>
</nav>

<div id="feed-view" class="view-container"></div>

<!-- CHAT -->
<div id="chat-view" class="hidden">
 <div class="chat-header">
  <span style="cursor:pointer;font-size:1.5rem" onclick="switchTab('feed')">‚¨ÖÔ∏è</span>
  <b>Chats</b>
 </div>

 <div id="msg-list" class="message-box"></div>

 <div class="chat-input-area">
  <input id="chat-input" class="chat-input" placeholder="Message...">
  <button onclick="sendMsg()" style="color:var(--pw-blue);background:none;border:none;font-weight:bold">Send</button>
 </div>
</div>

<div id="profile-view" class="view-container hidden" style="text-align:center;padding-top:50px">
 <h3 id="p-name"></h3>
 <button onclick="logout()" style="background:#e74c3c;color:white;border:none;padding:10px 20px;border-radius:8px">Logout</button>
</div>

<div id="bottom-nav" class="bottom-bar">
 <div onclick="switchTab('feed')">üè†</div>
 <div onclick="switchTab('profile')">üë§</div>
</div>

</div>

<script>
const supabaseUrl='https://xgxmbfbuplkzwnrueusy.supabase.co';
const supabaseKey='sb_publishable_W-5nmUs4gRcD0BDsv7BM9w_R6rpx87j';
const _supabase=supabase.createClient(supabaseUrl,supabaseKey);

let msgSubscribed=false;

async function init(){
 const {data:{session}}=await _supabase.auth.getSession();
 updateUI(session);
 document.getElementById('loader').classList.add('hidden');
}

_supabase.auth.onAuthStateChange((_e,session)=>updateUI(session));

function updateUI(session){
 const authPage=document.getElementById('auth-page');
 const mainApp=document.getElementById('main-app');
 const pName=document.getElementById('p-name');

 if(session){
  authPage.classList.add('hidden');
  mainApp.classList.remove('hidden');
  pName.innerText=session.user.email;
  fetchFeed();
  listenMessages(session.user.id);
 }else{
  authPage.classList.remove('hidden');
  mainApp.classList.add('hidden');
 }
}

function switchTab(tab){
 ['feed-view','profile-view','chat-view'].forEach(v=>document.getElementById(v).classList.add('hidden'));
 document.getElementById('top-nav').classList.remove('hidden');
 document.getElementById('bottom-nav').classList.remove('hidden');

 if(tab==='feed')document.getElementById('feed-view').classList.remove('hidden');
 if(tab==='profile')document.getElementById('profile-view').classList.remove('hidden');
 if(tab==='chat'){
  document.getElementById('chat-view').classList.remove('hidden');
  document.getElementById('top-nav').classList.add('hidden');
  document.getElementById('bottom-nav').classList.add('hidden');
 }
}

function listenMessages(uid){
 if(msgSubscribed)return;
 msgSubscribed=true;

 _supabase.channel('messages')
 .on('postgres_changes',{event:'INSERT',table:'messages'},payload=>{
  const isSent=payload.new.sender_id===uid;
  document.getElementById('msg-list').innerHTML+=
   `<div class="msg ${isSent?'sent':'received'}">${payload.new.text}</div>`;
 }).subscribe();
}

async function sendMsg(){
 const input=document.getElementById('chat-input');
 const {data:{user}}=await _supabase.auth.getUser();
 if(!input.value.trim())return;
 await _supabase.from('messages').insert([{sender_id:user.id,receiver_id:user.id,text:input.value}]);
 input.value='';
}

async function fetchFeed(){
 const {data}=await _supabase.from('posts').select('*').order('created_at',{ascending:false});
 const feed=document.getElementById('feed-view');
 feed.innerHTML='';
 data?.forEach(p=>{
  feed.innerHTML+=`<div style="padding:15px"><img src="${p.image_url}" style="width:100%;border-radius:12px"></div>`;
 });
}

async function handleAuth(){
 await _supabase.auth.signInWithPassword({
  email:document.getElementById('u-email').value,
  password:document.getElementById('u-pass').value
 });
}

async function logout(){await _supabase.auth.signOut()}

window.onload=init;
</script>

</body>
</html>
